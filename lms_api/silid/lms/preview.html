{% extends "templates/base.html" %}
{% block title %}{{ content.title or 'Content Page' }}{% endblock %}



{% block head_include %}
<style>
	.lms-content {
		line-height: 1.8em;
	}

	.lms-content h1 {
		margin-top: 1em;
	}

	.lms-content h2 {
		margin-top: 1em;
	}

	.lms-content h3 {
		margin-top: 0.8em;
	}

	.lms-content h4 {
		margin-top: 0.6em;
	}

	section {
		padding: 5rem 0 5rem 0;
	}

	.plyr--video .plyr__control.plyr__tab-focus,
	.plyr--video .plyr__control:hover,
	.plyr--video .plyr__control[aria-expanded='true'] {
		background: #5e64ff !important;
	}

	.plyr__control--overlaid:focus,
	.plyr__control--overlaid:hover {
		background: #5e64ff !important;
	}

	.plyr__menu__container .plyr__control[role=menuitemradio][aria-checked=true]::before {
		background: #5e64ff !important;
	}

	.plyr__menu__container .plyr__control[role='menuitemradio'][aria-checked='true']::before {
		background: #5e64ff;
	}

	.plyr--full-ui input[type='range'] {
		color: #5e64ff !important;
	}

	.plyr__control--overlaid {
		background: rgba(94, 100, 255, 0.8) !important;
	}
	.progress-bar {
		height:35px;
		width:250px;
		border: 1px solid #0a8e20;
		display:none;
	}
	.progress-bar-fill {
		height:100%;
		width:0%;
		background: lightgreen;
		display:flex;
		align-items:center;
		font-weight:bold;
		transition:width 0.25s;
	}
	.progress-bar-text{
		margin-left:10px;
		font-weight:bold;
	}
	label {
		display: inline-block;
		margin-bottom: 0.5rem !important;
		font-size: 23px !important;
		font-weight: bolder !important;
	}
	.form-check-input {
		margin-top: 0.6rem !important;
	}
</style>


<style type="text/css" media="print">
	BODY {
		display: none;
		visibility: hidden;
	}
</style>

<link rel="stylesheet" href="https://cdn.plyr.io/3.5.3/plyr.css" />
{% endblock %}

{% macro title() %}
<div class="mb-3">
	<h1 class="text-muted" style="color:blue">This is a preview of what the quiz</h1>
</div>
<div>
	<h1>{{ content.title }} <span class="small text-muted">({{ position + 1 }}/{{length}})</span></h1>
	<br>
	{% if content.time_limit %}
	<h1 id="quiz_timer">Time Limit: {{ content.time_limit }} minutes</h1>
	{% endif %}
</div>


{% endmacro %}

{% macro navigation() %}
{% if content.publish_date.strftime('%Y-%m-%d %H:%M:%S.%f') <= frappe.utils.now() %}
{% if previous %}

<a href="/lms/content?program={{ program }}&course={{ course }}&topic={{ topic }}&type={{ previous.content_type }}&content={{ previous.content }}"
	class='btn text-muted' style="box-shadow: none;">Previous</a>
{% else %}

<a href="/lms/course?name={{ course }}&program={{ program }}" class='btn text-muted' style="box-shadow: none;">Back to
	Course</a>
{% endif %}

{% if next %}

<button id="nextButton"
	onclick="handle('/lms/content?program={{ program }}&course={{ course }}&topic={{ topic }}&type={{ next.content_type }}&content={{ next.content }}')"
	class='btn btn-primary' disabled="true">Finish Task</button>
{% else %}

<button id="nextButton" onclick="handle('/lms/course?name={{ course }}&program={{ program }}')" class='btn btn-primary'
	disabled="true">Finish Task</button>
{% endif %}
{% endif %}
{% endmacro %}

{% macro video() %}
<div class="mb-5">
	{{ title() }}
	<div class="text-muted">
		{% if content.duration %}
		{{ content.duration }} Mins
		{% endif %}

		{% if content.publish_date and content.duration%}
		-
		{% endif %}

		{% if content.publish_date %}
		Published on {{ content.publish_date.strftime('%d, %b %Y') }}
		{% endif %}
	</div>
</div>
{% if content.provider=="Google Drive" %}
<video id="player" playsinline controls>
	<source src="{{ content.url }}" type="video/mp4" />
</video>
{% else %}
<div id="player" data-plyr-provider="{{ content.provider|lower }}" data-plyr-embed-id="{{ content.url }}"></div>
{% endif %}
<div class="my-5 lms-content">
	{{ content.description }}
</div>
{% endmacro %}

{% macro article() %}
<div class="mb-5">
	{{ title() }}
	<div class="text-muted">
		{% if content.author or content.publish_date %}
		Published
		{% endif %}
		{% if content.author %}
		by {{ content.author }}
		{% endif %}
		{% if content.publish_date %}
		on {{ content.publish_date.strftime('%b %d, %Y') }}
		{% endif %}
		{% if content.deadline %}
		Deadline on {{ content.deadline.strftime('%b %d, %Y') }}
		{% endif %}
	</div>
</div>
<div class="lms-content">
	{{ content.content }}
</div>
{% endmacro %}

{% macro quiz() %}

<div class="mb-5">
	{{ title() }}
	<button class="btn btn-primary" id="start-quiz-button" onclick="start_quiz()">Start Quiz</button>
	<div id="quiz-wrapper"></div>
</div>
{% endmacro %}

{% block content %}

<section class="section">
	<div>
		<div class='container pb-5'>

				{% if content_type=='Video' %}
					{{ video() }}
				{% elif content_type=='Article'%}
					{{ article() }}
				{% elif content_type=='Quiz' %}
				{{ quiz() }}
				{% endif %}


			{% if content.doctype=='Video' %}

			{% set files = frappe.get_all('File',distinct=True, filters={'attached_to_doctype': content.doctype, 'attached_to_name': content.name}, fields=['file_name', 'file_url']) %}
			{%- for file in files -%}
			<div>Click on this link to Download: <a href="javascript:;" class="downloader-button" data-file-name="{{ file.file_name }}" data-file-url="{{ file.file_url }}">{{ file.file_name }}</a></div>
			{%- endfor -%}

			{% else %}

		    {% set files = frappe.get_all('File',distinct=True, filters={'attached_to_doctype': content.doctype, 'attached_to_name': content.name}, fields=['file_name', 'file_url']) %}
			{%- for file in files -%}
			<div>Click on this link to Download: <a href="javascript:;" class="downloader-button" data-file-name="{{ file.file_name }}" data-file-url="{{ file.file_url }}">{{ file.file_name }}</a></div>
			{%- endfor -%}

			{% endif %}
			{% if uploaded_files %}
			<br>
			<h4 style="color:green">Congratulations! You already have uploaded your work</h4>
			<b>Files you uploaded:</b>
			{% endif %}

			{%- for file in uploaded_files -%}
			<div><a href="javascript:;" class="downloader-button" data-file-name="{{ file.file_name }}" data-file-url="{{ file.file_url }}">{{ file.file_name }}</a> - Uploaded on {{ file.creation.strftime('%b %d, %Y %H:%M:%p') }} </div>
			{%- endfor -%}


			{% if content_type=='Article' or content_type=='Video' %}
				{% if content.publish_date %}
					{% if content.publish_date.strftime('%Y-%m-%d %H:%M:%S.%f') <= frappe.utils.now() %}
						{% if content.deadline %}
							{% if content.deadline.strftime('%Y-%m-%d %H:%M:%S.%f') > frappe.utils.now() %}
								<div style="margin-top: 20px; display:flex ">
									<form id="frmFileUp">
										<input type="file" id="select_files" name="select_files" multiple>
									</form>
								</div>
								 <br>
								<div class="progress-bar" id="progressBar">
									<div class="progress-bar-fill">
										<span class="progress-bar-text">0%</span>
									</div>
								</div>
								<div style="margin-top: 10px; display:flex ">
								<button id="btn_upload" class="btn btn-primary">Upload</button>
								</div>
							{% endif %}
						{% else %}
							<div style="margin-top: 20px; display:flex ">
								<form id="frmFileUp">
									<input type="file" id="select_files" name="select_files" multiple>
								</form>
							</div>
							 <br>
							<div class="progress-bar" id="progressBar">
								<div class="progress-bar-fill">
									<span class="progress-bar-text">0%</span>
								</div>
							</div>
							<div style="margin-top: 10px; display:flex ">
							<button id="btn_upload" class="btn btn-primary">Upload</button>
							</div>
						{% endif %}
					{% endif %}
				{% else %}
					<div style="margin-top: 20px; display:flex ">
						<form id="frmFileUp">
							<input type="file" id="select_files" name="select_files" multiple>
						</form>
					</div>
					 <br>
					<div class="progress-bar" id="progressBar">
						<div class="progress-bar-fill">
							<span class="progress-bar-text">0%</span>
						</div>
					</div>
					<div style="margin-top: 10px; display:flex ">
					<button id="btn_upload" class="btn btn-primary">Upload</button>
					</div>
				{% endif %}
			{% endif %}





			<script type="text/javascript">

                let download_file=function(e,i){let a=e.includes("private");window.open(`/api/method/lms_api.patches.private.download?is_private=${a}&filename=${e}`)};
				let downloader_function = function() {
					let file_name = this.getAttribute("data-file-name");
				  	let file_url = this.getAttribute("data-file-url");
				  	download_file(`${encodeURIComponent(file_url)}`, `${file_name}`);
				}
				window.onload = function() {
					let elements = document.getElementsByClassName("downloader-button");
					for (var i = 0; i < elements.length; i++) {
						elements[i].addEventListener('click', downloader_function, false);
					}
				}

				frappe.ready(function () {
					var $form = $("form[id='frmFileUp']");

					$form.on("change", "[type='file']", function () {
						var $input = $(this);
						var input = $input.get(0);

						if (input.files.length) {
							input.filedata = { "files_data": [] }; //Initialize as json array.

							window.file_reading = true;

							$.each(input.files, function (key, value) {
								setupReader(value, input);
							});

							window.file_reading = false;
						}
					});

					$("#btn_upload").click(function () {
						$(".progress-bar").show();
						var projname = $('#projname').val();
						var filedata = $('#select_files').prop('filedata');

						let progressBarFill = document.querySelector("#progressBar > .progress-bar-fill");
						let progressBarText = progressBarFill.querySelector(".progress-bar-text");
						var xhr = new XMLHttpRequest();
						xhr.upload.addEventListener('progress', function (e) {
							let percent = e.lengthComputable ? (e.loaded / e.total) * 100 : 0;
							if (parseInt(percent) === 100) {
								percent = 99;
							}
							progressBarFill.style.width = percent.toFixed(2) + "%";
							progressBarText.textContent = percent.toFixed(2) + "%";

						});
						xhr.onreadystatechange = function () {
							if (xhr.readyState == XMLHttpRequest.DONE) {
								if (xhr.status === 200) {
									percent = 100;
									progressBarFill.style.width = percent.toFixed(2) + "%";
									progressBarText.textContent = percent.toFixed(2) + "%";
									opts = {
										method: "erpnext.education.utils.add_activity",
										args: {
											course: `{{ course }}`,
											content_type: `{{ content_type }}`,
											content: `{{ content.name }}`,
											program: `{{ program }}`
										}
									}
									frappe.call(opts).then(res => {})
									frappe.msgprint({
										title: "File Upload",
										indicator: 'green',
										message: "File(s) uploaded successfully.",
										primary_action: {
											'label': 'Confirm',
											action(values) {
												this.hide();
												window.location.reload();
											}
										}
									});
								} else {
									frappe.msgprint({
										title: "File Upload",
										indicator: 'red',
										message: "File was not uploaded.",
										primary_action: {
											'label': 'Confirm',
											action(values) {
												this.hide();
												window.location.reload();
											}
										}
									});
								}
							}
						};
						xhr.open('POST', '/api/method/lms_api.silid.attach_file.attach_file_to_project', true);
						xhr.setRequestHeader('Accept', 'application/json');
            			xhr.setRequestHeader('X-Frappe-CSRF-Token', frappe.csrf_token);
            			var form_data = new FormData();
            			form_data.append('work', `{{ content.name }}`);
            			form_data.append('title', `{{ content.name }}`);
            			form_data.append('work_title', `{{ content.title }}`);
            			form_data.append('student', `{{ frappe.session.user }}`);
            			form_data.append('doctype', `{{ content.doctype }}`);
            			form_data.append('course', `{{ course }}`);
            			form_data.append('topic', `{{ topic }}`);
            			form_data.append('program', `{{ program }}`);
            			form_data.append('filedata', JSON.stringify(filedata));
						xhr.send(form_data);
						/*frappe.call({
							method: "lms_api.silid.attach_file.attach_file_to_project",
							args: {

								filedata: filedata,
								work: `{{ content.name }}`,
								title: `{{ content.name }}`,
								work_title: `{{ content.title }}`,
								student: `{{ frappe.session.user }}`,
								doctype: `{{ content.doctype }}`,
								course: `{{ course }}`

							},
							freeze: false,
							freeze_message: __("Upload files..."),
							callback: function (r) {
								if (!r.exc) {
									frappe.msgprint({
										title: "File Upload",
										indicator: 'green',
										message: "File(s) uploaded successfully.",
										primary_action: {
											'label': 'Confirm',
											action(values) {
												this.hide();
												window.location.reload();
											}
										}
									});
								} else {
									frappe.msgprint({
										title: "File Upload",
										indicator: 'red',
										message: "File was not uploaded.",
										primary_action: {
											'label': 'Confirm',
											action(values) {
												this.hide();
												window.location.reload();
											}
										}
									});
								}
							}
						});*/
					});
				});

				function setupReader(file, input) {
					var name = file.name;
					var reader = new FileReader();
					reader.onload = function (e) {
						input.filedata.files_data.push({
							"__file_attachment": 1,
							"filename": file.name,
							"dataurl": reader.result
						})
					}
					reader.readAsDataURL(file);
				}
			</script>



			<div class="pull-right" {{ 'hidden' if content_type=='Quiz'}}>
				{{ navigation() }}
			</div>
		</div>
	</div>
</section>
{% endblock %}

{% block script %}
{% if content_type=='Video' %}
<script src="https://cdn.plyr.io/3.5.3/plyr.js"></script>
{% elif content_type == 'Quiz' %}
<script src='/assets/erpnext/js/education/lms/quiz.js'>
</script>

{% endif  %}


<script type="text/javascript">

	var countDownDate = "";
	let built = 0;
	frappe.ready(function () {
		frappe.call({
			method: "lms_api.lms_api.doctype.time_limit.time_limit.get_limit",
			args: {
				content_name: `{{ content.name }}`
			},
			async: false,
			callback: function(r){
				if(r.message !== undefined){
					countDownDate = r.message;
					start_quiz();
				}
			}
		})
	});
	let start_quiz = function(){
		if (built === 0) {
			$("#start-quiz-button").hide();
			start_countdown();
			build_quiz();

			built = 1;
		} else {
			console.log("Quiz already built");
		}
	};

	let start_interval = function(countDownDate) {
		// Update the count down every 1 second
		let count_interval = setInterval(function () {

			// Get today's date and time
			var now = new Date().getTime();
			// Find the distance between now and the count down date
			var distance = countDownDate - now;
			// Time calculations for days, hours, minutes and seconds
			var days = Math.floor(distance / (1000 * 60 * 60 * 24));
			var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
			var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
			var seconds = Math.floor((distance % (1000 * 60)) / 1000);

			// Output the result in an element with id="demo"
			let quiz_timer_element = document.getElementById("quiz_timer")
			if (quiz_timer_element!=null){
				document.getElementById("quiz_timer").innerHTML = "Time Remaining:" + days + "d " + hours + "h " + minutes + "m " + seconds + "s ";
			} else {
				clearInterval(count_interval);
			}


			// If the count down is over, write some text
			if (distance < 0) {
				clearInterval(count_interval);
				document.getElementById("quiz_timer").innerHTML = "Time's up!";


				var x = document.getElementById("submit-button");
				if (x.style.display === "none") {
				} else {
					$("#submit-button").click();
					frappe.msgprint("Time is up! Your quiz is submitted automatically!");
					//x.style.display = "none";
				}

				var x = document.getElementById("select_files");
				if (x != undefined) {
					if (x.style.display === "none") {
					} else {
						x.style.display = "none";
					}
				}

			}
		}, 1000);
	}

	// Set the date we're counting down to
	let start_countdown = function() {

		frappe.call({
			method: "lms_api.lms_api.doctype.time_limit.time_limit.get_limit",
			args: {
				content_name: `{{ content.name }}`
			},
			async: false,
			callback: function(r){
				if(r.message !== undefined){
					countDownDate = r.message;
					start_interval(parseInt(countDownDate)+5000)
				}else {
					countDownDate = new Date();
					countDownDate.setMinutes(countDownDate.getMinutes() + {{ content.time_limit }});
					countDownDate = countDownDate.getTime();
					frappe.call({
						method: "lms_api.lms_api.doctype.time_limit.time_limit.set_limit",
						args: {
							content_name: `{{ content.name }}`,
							time_started: countDownDate,
							content_title: `{{ content.title }}`
						},
						async: false,
						callback: function(res) {
							console.log("Timer Set");
							$("#quiz-wrapper a").attr("target", "_blank");
							start_interval(parseInt(countDownDate)+5000)
						}
					})
				}
			}
		})


	};
</script>

<script>
	{% if content_type == 'Video' %}
	const player = new Plyr('#player');
	{% elif content_type == 'Quiz' %}
	{% if next %}
	const quiz_exit_button = 'Finish Task'
	const next_url = `/lms/content?program={{ program }}&course={{ course }}&topic={{ topic }}&type={{ next.content_type }}&content={{ next.content }}`
	{% else %}
	const quiz_exit_button = 'Finish Task'
	const next_url = `/lms/course?name={{ course }}&program={{ program }}`
	{% endif %}

	let build_quiz = function(){
		//frappe.ready(() => {
		const quiz = new Quiz(document.getElementById('quiz-wrapper'), {
			name: `{{ content.name }}`,
			course: `{{ course }}`,
			program: `{{ program }}`,
			quiz_exit_button: quiz_exit_button,
			next_url: next_url
		})
		window.quiz = quiz;

		//})
	}
	{% endif %}

	{% if content_type != 'Quiz' %}

	frappe.ready(() => {
		next = document.getElementById('nextButton')
		next.disabled = false;
	})


	function handle(url) {
		opts = {
			method: "erpnext.education.utils.add_activity",
			args: {
				course: `{{ course }}`,
				content_type: `{{ content_type }}`,
				content: `{{ content.name }}`,
				program: `{{ program }}`
			}
		}
		frappe.call(opts).then(res => {
			window.location.href = url;
		})
	}

	{% endif %}
</script>
{% endblock %}
